<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รีเซ็ตรหัสผ่าน - โรงเรียนสกลราชวิทยานุกูล</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Sarabun:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-red: #C00000;
            --light-bg: #F8F9FA;
            --white: #FFFFFF;
        }
        body {
            font-family: 'Sarabun', 'Prompt', sans-serif;
            background-color: var(--light-bg);
        }
        .navbar-brand img {
            height: 40px;
            margin-right: 10px;
        }
        .sidebar {
            background-color: var(--white);
            min-height: calc(100vh - 56px);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .sidebar .nav-link {
            color: #333;
            padding: 12px 20px;
            border-left: 4px solid transparent;
        }
        .sidebar .nav-link.active {
            background-color: var(--light-bg);
            border-left-color: var(--primary-red);
            color: var(--primary-red);
        }
        .sidebar .nav-link:hover {
            background-color: var(--light-bg);
        }
        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: var(--primary-red);
            color: white;
            font-weight: 500;
        }
        .btn-primary {
            background-color: var(--primary-red);
            border-color: var(--primary-red);
        }
        .btn-primary:hover {
            background-color: #A00000;
            border-color: #A00000;
        }
        .user-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .user-card:hover {
            border-color: var(--primary-red);
            box-shadow: 0 0 10px rgba(192, 0, 0, 0.1);
        }
        .role-badge {
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 500;
        }
        .badge-admin { background-color: #dc3545; color: white; }
        .badge-teacher { background-color: #0d6efd; color: white; }
        .badge-student { background-color: #198754; color: white; }
        .password-display {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px dashed #6c757d;
            font-size: 1.1em;
            letter-spacing: 1px;
        }
        .copy-btn {
            cursor: pointer;
            transition: all 0.3s;
        }
        .copy-btn:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="assets/logo.png" alt="โรงเรียนสกลราชวิทยานุกูล">
                <span class="fw-bold" style="color: var(--primary-red);">ระบบบันทึกการเรียนการสอน<br><small>โรงเรียนสกลราชวิทยานุกูล</small></span>
            </a>
            <div class="navbar-nav ms-auto align-items-center">
                <span class="nav-item me-3">
                    <span id="navbarUser"></span>
                    <span class="role-badge badge-admin">ผู้ดูแลระบบ</span>
                </span>
                <a href="dashboard_admin.html" class="nav-link me-3">
                    <i class="bi bi-speedometer2"></i> แดชบอร์ด
                </a>
                <a href="#" id="logoutBtn" class="nav-link btn btn-outline-danger">
                    <i class="bi bi-box-arrow-right"></i> ออกจากระบบ
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 col-lg-2 d-md-block sidebar collapse p-0">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard_admin.html">
                                <i class="bi bi-speedometer2 me-2"></i> แดชบอร์ด
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="users.html">
                                <i class="bi bi-people me-2"></i> จัดการผู้ใช้
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="subjects.html">
                                <i class="bi bi-book me-2"></i> จัดการรายวิชา
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="report.html">
                                <i class="bi bi-clipboard-check me-2"></i> รายงานการสอน
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="history.html">
                                <i class="bi bi-clock-history me-2"></i> ประวัติรายงาน
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="retrospective.html">
                                <i class="bi bi-graph-up me-2"></i> สถิติและรายงาน
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="reset-password.html">
                                <i class="bi bi-key me-2"></i> รีเซ็ตรหัสผ่าน
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 col-lg-10 ms-sm-auto px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">รีเซ็ตรหัสผ่านผู้ใช้</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshUsers()">
                            <i class="bi bi-arrow-clockwise"></i> รีเฟรช
                        </button>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="searchUser" placeholder="ค้นหาผู้ใช้...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterRole">
                            <option value="">ทุกบทบาท</option>
                            <option value="admin">ผู้ดูแลระบบ</option>
                            <option value="teacher">ครูผู้สอน</option>
                            <option value="student">ตัวแทนห้อง</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterStatus">
                            <option value="">ทุกสถานะ</option>
                            <option value="active">ใช้งานปกติ</option>
                            <option value="inactive">ระงับการใช้งาน</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-primary w-100" onclick="applyFilters()">
                            <i class="bi bi-funnel"></i> กรอง
                        </button>
                    </div>
                </div>

                <!-- Information Alert -->
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle"></i> <strong>คำแนะนำ:</strong> ผู้ดูแลระบบสามารถรีเซ็ตรหัสผ่านให้กับผู้ใช้ทุกคนได้ ระบบจะสร้างรหัสผ่านชั่วคราวให้อัตโนมัติ
                </div>

                <!-- Users List -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-people me-2"></i> รายชื่อผู้ใช้ทั้งหมด
                        <span class="badge bg-primary ms-2" id="userCount">0</span>
                    </div>
                    <div class="card-body">
                        <div id="usersList">
                            <!-- User cards will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Reset History -->
                <div class="card mt-4">
                    <div class="card-header">
                        <i class="bi bi-clock-history me-2"></i> ประวัติการรีเซ็ตรหัสผ่าน
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>วันที่</th>
                                        <th>ผู้ใช้</th>
                                        <th>บทบาท</th>
                                        <th>รีเซ็ตโดย</th>
                                        <th>รหัสผ่านชั่วคราว</th>
                                        <th>สถานะ</th>
                                    </tr>
                                </thead>
                                <tbody id="resetHistory">
                                    <!-- History will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resetPasswordModalLabel">รีเซ็ตรหัสผ่าน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="bi bi-key fs-1 text-primary"></i>
                        <h5 class="mt-3">คุณต้องการรีเซ็ตรหัสผ่านสำหรับ</h5>
                        <h4 id="resetUserName" class="text-primary"></h4>
                        <p id="resetUserRole" class="text-muted"></p>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> <strong>คำเตือน:</strong> หลังจากรีเซ็ตรหัสผ่าน ผู้ใช้จะต้องเปลี่ยนรหัสผ่านใหม่ในการเข้าสู่ระบบครั้งถัดไป
                    </div>
                    
                    <div class="mb-3">
                        <label for="resetReason" class="form-label">เหตุผลในการรีเซ็ต</label>
                        <select class="form-select" id="resetReason">
                            <option value="forgot">ผู้ใช้ลืมรหัสผ่าน</option>
                            <option value="security">เหตุผลด้านความปลอดภัย</option>
                            <option value="first_time">ผู้ใช้ใหม่</option>
                            <option value="other">อื่นๆ</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="otherReasonDiv" style="display: none;">
                        <label for="otherReason" class="form-label">ระบุเหตุผล</label>
                        <textarea class="form-control" id="otherReason" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notifyUser" checked>
                            <label class="form-check-label" for="notifyUser">
                                แจ้งเตือนผู้ใช้ผ่านอีเมล
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" id="confirmReset">รีเซ็ตรหัสผ่าน</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resultModalLabel">ผลการรีเซ็ตรหัสผ่าน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="bi bi-check-circle fs-1 text-success"></i>
                        <h5 class="mt-3">รีเซ็ตรหัสผ่านสำเร็จ!</h5>
                    </div>
                    
                    <div class="alert alert-success">
                        <h6>ข้อมูลการรีเซ็ต:</h6>
                        <p><strong>ผู้ใช้:</strong> <span id="resultUserName"></span></p>
                        <p><strong>รหัสผ่านชั่วคราว:</strong></p>
                        <div class="password-display d-flex justify-content-between align-items-center">
                            <span id="tempPasswordDisplay"></span>
                            <button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyTempPassword()">
                                <i class="bi bi-clipboard"></i> คัดลอก
                            </button>
                        </div>
                        <p class="mt-2 mb-0"><small class="text-danger">กรุณาบันทึกรหัสผ่านนี้และส่งให้ผู้ใช้</small></p>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> รหัสผ่านชั่วคราวนี้จะถูกเก็บไว้ในระบบเป็นเวลา 24 ชั่วโมง
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="refreshUsers()">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer mt-auto py-3 bg-white border-top">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <span class="text-muted">พัฒนาโดยฝ่ายบริหารงานวิชาการ โรงเรียนสกลราชวิทยานุกูล</span>
                </div>
                <div class="col-md-6 text-end">
                    <span class="text-muted">© 2024 ระบบบันทึกการเรียนการสอน</span>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let users = [];
        let filteredUsers = [];
        let selectedUser = null;
        let resetHistory = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is admin
            if (!Auth.isAuthenticated() || !Auth.hasRole('admin')) {
                alert('เฉพาะผู้ดูแลระบบเท่านั้นที่สามารถเข้าถึงหน้านี้ได้');
                window.location.href = 'login.html';
                return;
            }
            
            // Update user info in navbar
            const user = Auth.getCurrentUser();
            if (user) {
                document.getElementById('navbarUser').textContent = user.name;
            }
            
            // Load users
            loadUsers();
            
            // Load reset history
            loadResetHistory();
            
            // Setup event listeners
            setupEventListeners();
        });
        
        async function loadUsers() {
            try {
                window.app.showLoading();
                
                // Get all users from Auth module
                users = Auth.getAllUsers();
                
                // Filter out current admin (don't allow resetting own password from here)
                users = users.filter(user => user.username !== Auth.getCurrentUser()?.username);
                
                // Apply initial filter
                applyFilters();
                
                window.app.hideLoading();
            } catch (error) {
                console.error('Error loading users:', error);
                window.app.hideLoading();
                window.app.showToast('เกิดข้อผิดพลาดในการโหลดข้อมูลผู้ใช้', 'danger');
            }
        }
        
        function renderUsers() {
            const container = document.getElementById('usersList');
            
            if (filteredUsers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-person-x fs-1 text-muted"></i>
                        <p class="mt-3">ไม่พบผู้ใช้</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredUsers.map(user => `
                <div class="user-card">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="bi bi-person-circle fs-3 text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">${user.name}</h6>
                                    <small class="text-muted">${user.username}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <span class="role-badge ${getRoleBadgeClass(user.role)}">
                                ${getRoleThai(user.role)}
                            </span>
                        </div>
                        <div class="col-md-3">
                            <div><i class="bi bi-envelope me-1"></i> ${user.email || '-'}</div>
                            ${user.classroom ? `<div><i class="bi bi-building me-1"></i> ${user.classroom}</div>` : ''}
                        </div>
                        <div class="col-md-2">
                            <span class="badge bg-success">ใช้งานปกติ</span>
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-sm btn-danger" onclick="showResetModal('${user.username}')">
                                <i class="bi bi-key"></i> รีเซ็ตรหัสผ่าน
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Update user count
            document.getElementById('userCount').textContent = filteredUsers.length;
        }
        
        function applyFilters() {
            const searchTerm = document.getElementById('searchUser').value.toLowerCase();
            const roleFilter = document.getElementById('filterRole').value;
            const statusFilter = document.getElementById('filterStatus').value;
            
            filteredUsers = users.filter(user => {
                const matchesSearch = searchTerm === '' || 
                    user.username.toLowerCase().includes(searchTerm) ||
                    user.name.toLowerCase().includes(searchTerm) ||
                    (user.email && user.email.toLowerCase().includes(searchTerm));
                
                const matchesRole = roleFilter === '' || user.role === roleFilter;
                const matchesStatus = statusFilter === ''; // Simplified for demo
                
                return matchesSearch && matchesRole && matchesStatus;
            });
            
            renderUsers();
        }
        
        function getRoleBadgeClass(role) {
            switch(role) {
                case 'admin': return 'badge-admin';
                case 'teacher': return 'badge-teacher';
                case 'student': return 'badge-student';
                default: return 'badge-secondary';
            }
        }
        
        function getRoleThai(role) {
            switch(role) {
                case 'admin': return 'ผู้ดูแลระบบ';
                case 'teacher': return 'ครูผู้สอน';
                case 'student': return 'ตัวแทนห้อง';
                default: return role;
            }
        }
        
        function showResetModal(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            selectedUser = user;
            
            document.getElementById('resetUserName').textContent = `${user.name} (${user.username})`;
            document.getElementById('resetUserRole').textContent = getRoleThai(user.role);
            
            const modal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
            modal.show();
        }
        
        function loadResetHistory() {
            // Load reset history from localStorage
            resetHistory = JSON.parse(localStorage.getItem('passwordResetHistory') || '[]');
            renderResetHistory();
        }
        
        function renderResetHistory() {
            const tbody = document.getElementById('resetHistory');
            
            if (resetHistory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="bi bi-clock-history text-muted fs-3"></i>
                            <p class="mt-2 mb-0">ยังไม่มีประวัติการรีเซ็ตรหัสผ่าน</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Show last 10 resets
            const recentHistory = resetHistory.slice(-10).reverse();
            
            tbody.innerHTML = recentHistory.map(record => `
                <tr>
                    <td>${formatDateTime(record.timestamp)}</td>
                    <td>${record.userName}<br><small class="text-muted">${record.username}</small></td>
                    <td><span class="role-badge ${getRoleBadgeClass(record.role)}">${getRoleThai(record.role)}</span></td>
                    <td>${record.resetBy}</td>
                    <td>
                        <span class="password-display" style="font-size: 0.8em;">
                            ${maskPassword(record.tempPassword)}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${record.status === 'success' ? 'bg-success' : 'bg-danger'}">
                            ${record.status === 'success' ? 'สำเร็จ' : 'ล้มเหลว'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }
        
        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function maskPassword(password) {
            if (!password) return '';
            const firstTwo = password.substring(0, 2);
            const lastTwo = password.substring(password.length - 2);
            return `${firstTwo}${'*'.repeat(password.length - 4)}${lastTwo}`;
        }
        
        function setupEventListeners() {
            // Search input
            const searchInput = document.getElementById('searchUser');
            if (searchInput) {
                searchInput.addEventListener('input', Utils.debounce(() => {
                    applyFilters();
                }, 300));
            }
            
            // Filter select change
            document.getElementById('filterRole').addEventListener('change', applyFilters);
            document.getElementById('filterStatus').addEventListener('change', applyFilters);
            
            // Reset reason change
            document.getElementById('resetReason').addEventListener('change', function() {
                const otherReasonDiv = document.getElementById('otherReasonDiv');
                otherReasonDiv.style.display = this.value === 'other' ? 'block' : 'none';
            });
            
            // Confirm reset button
            document.getElementById('confirmReset').addEventListener('click', resetPassword);
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                window.app.showLogoutConfirm();
            });
        }
        
        function resetPassword() {
            if (!selectedUser) return;
            
            const reason = document.getElementById('resetReason').value;
            const otherReason = document.getElementById('otherReason').value;
            const notifyUser = document.getElementById('notifyUser').checked;
            const adminUser = Auth.getCurrentUser();
            
            // Call Auth module to reset password
            const result = Auth.resetPassword(selectedUser.username);
            
            if (result.success) {
                // Record in history
                const resetRecord = {
                    timestamp: new Date().toISOString(),
                    username: selectedUser.username,
                    userName: selectedUser.name,
                    role: selectedUser.role,
                    tempPassword: result.tempPassword,
                    resetBy: adminUser.name,
                    reason: reason === 'other' ? otherReason : reason,
                    notifyUser: notifyUser,
                    status: 'success'
                };
                
                resetHistory.push(resetRecord);
                localStorage.setItem('passwordResetHistory', JSON.stringify(resetHistory));
                
                // Show result modal
                document.getElementById('resultUserName').textContent = selectedUser.name;
                document.getElementById('tempPasswordDisplay').textContent = result.tempPassword;
                
                // Close reset modal
                const resetModal = bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal'));
                resetModal.hide();
                
                // Show result modal
                const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                resultModal.show();
                
                // Update history display
                renderResetHistory();
                
                // Send notification if requested
                if (notifyUser && selectedUser.email) {
                    sendPasswordResetEmail(selectedUser, result.tempPassword);
                }
            } else {
                window.app.showToast('รีเซ็ตรหัสผ่านล้มเหลว: ' + result.error, 'danger');
            }
        }
        
        function sendPasswordResetEmail(user, tempPassword) {
            // In production, this would send an actual email
            console.log(`Sending password reset email to ${user.email}`);
            console.log(`Temporary password: ${tempPassword}`);
            
            // For demo, show notification
            window.app.showToast(`ส่งอีเมลแจ้งเตือนไปยัง ${user.email} แล้ว`);
        }
        
        function copyTempPassword() {
            const tempPassword = document.getElementById('tempPasswordDisplay').textContent;
            navigator.clipboard.writeText(tempPassword).then(() => {
                window.app.showToast('คัดลอกรหัสผ่านชั่วคราวเรียบร้อยแล้ว');
            });
        }
        
        function refreshUsers() {
            loadUsers();
            loadResetHistory();
            window.app.showToast('รีเฟรชข้อมูลสำเร็จ');
        }
    </script>
</body>
</html>